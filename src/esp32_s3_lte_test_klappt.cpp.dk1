#include <Arduino.h>
#include <TinyGsmClient.h>

// -------- Board-Pins (Waveshare ESP32-S3-A7670E-4G) --------
static const int MODEM_PWRKEY = 33;   // PWRKEY zum Einschalten des A7670E
static const int MODEM_RX     = 17;   // ESP32-S3 RX  (an Modem TX)
static const int MODEM_TX     = 18;   // ESP32-S3 TX  (an Modem RX)
static const uint32_t MODEM_BAUD = 115200; // A7670E werkseitig 115200

// -------- SIM / APN (O2 Deutschland) --------
#define SIM_PIN ""                 // ggf. "1234"
const char APN[]  = "internet";
const char USER[] = "";
const char PASS[] = "";

// -------- TinyGSM Setup --------
#define TINY_GSM_MODEM_SIM7600     // für A76xx Familie
HardwareSerial ModemSerial(2);     // UART2 am ESP32-S3
TinyGsm       modem(ModemSerial);
TinyGsmClient net(modem);

// Kleine Helfer: AT senden + Antwort anzeigen
void sendAT(const String& cmd, uint32_t timeout = 4000) {
  Serial.print(">> AT"); Serial.println(cmd);
  modem.sendAT(cmd.c_str());
  String resp; modem.waitResponse(timeout, resp);
  Serial.println(resp); Serial.println();
}

void powerOnModem() {
  pinMode(MODEM_PWRKEY, OUTPUT);
  // A7670E: PWRKEY ~1s auf HIGH/LOW abhängig vom Board-Design.
  // Waveshare-Boards schalten i.d.R. über einen Transistor.
  // Der folgende Puls funktioniert in der Praxis:
  digitalWrite(MODEM_PWRKEY, HIGH);
  delay(1100);
  digitalWrite(MODEM_PWRKEY, LOW);
  delay(2000);
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("\n=== A7670E LTE Test (O2) ===");

  // UART fürs Modem
  ModemSerial.begin(MODEM_BAUD, SERIAL_8N1, MODEM_RX, MODEM_TX);

  // Modem einschalten
  powerOnModem();

  Serial.println("Modem restart...");
  modem.restart();                 // Soft-Reset via TinyGSM
  // Alternativ: modem.init();

  if (strlen(SIM_PIN) > 0) {
    modem.simUnlock(SIM_PIN);
  }

  // Grunddiagnose
  sendAT("+CPIN?");                // SIM-Status
  sendAT("+CSQ");                  // Signal
  sendAT("+CREG?");                // Netzregistrierung

  // Netz warten (registrieren)
  Serial.print("Warte auf Netz...");
  if (!modem.waitForNetwork(60000L)) {   // bis zu 60s
    Serial.println(" FEHLER: kein Netz.");
    return;
  }
  Serial.println(" OK.");

  // APN verbinden (normales LTE/PPP)
  Serial.print("Verbinde APN: "); Serial.println(APN);
  if (!modem.gprsConnect(APN, USER, PASS)) {
    Serial.println("FEHLER: APN-Verbindung fehlgeschlagen!");
    return;
  }
  Serial.println("GPRS/LTE verbunden.");

  // --- Ping (AT+SNPING4) ---
  Serial.println("Ping google.de (AT+SNPING4)...");
  modem.sendAT("+SNPING4=\"google.de\",1,16,5000");
  {
    String resp; modem.waitResponse(10000, resp);
    Serial.println(resp);
  }

  // --- HTTP-GET (einfach, über TCP-Socket) ---
  Serial.println("\nHTTP-GET zu example.org ...");
  if (!net.connect("example.org", 80)) {
    Serial.println("TCP connect fehlgeschlagen.");
  } else {
    // Minimaler HTTP-GET
    net.print(String("GET / HTTP/1.1\r\n") +
              "Host: example.org\r\n" +
              "Connection: close\r\n\r\n");

    // Antwort lesen (ein paar Sekunden)
    uint32_t t0 = millis();
    while (millis() - t0 < 8000) {
      while (net.available()) {
        char c = net.read();
        Serial.write(c);
      }
      if (!net.connected()) break;
      delay(10);
    }
    net.stop();
    Serial.println("\n--- HTTP fertig ---");
  }

  // Optional: IP anzeigen
  Serial.print("IP: "); Serial.println(modem.getLocalIP());

  // Verbindung offen lassen – im loop() könnte man weiter arbeiten
}

void loop() {
  // Status-Heartbeat alle 10s (Signal + Registrierung)
  static uint32_t last = 0;
  if (millis() - last > 10000) {
    last = millis();
    sendAT("+CSQ", 1500);
    sendAT("+CREG?", 1500);
  }
}

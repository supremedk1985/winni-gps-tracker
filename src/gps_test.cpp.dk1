#include <Arduino.h>

// TinyGSM muss VOR dem Include wissen, welches Modem
#define TINY_GSM_MODEM_SIM7000
#include <TinyGsmClient.h>

// SIM7000G → ESP32 Pins
#define MODEM_PWR 4
#define MODEM_RX 26
#define MODEM_TX 27
#define MODEM_BAUD 9600

HardwareSerial hwSerial(2);       // UART2 für SIM7000G
TinyGsm modem(hwSerial);

void setup() {
  Serial.begin(115200);
  delay(3000);
  Serial.println("Starte SIM7000G GPS mit TinyGSM...");

  // UART starten
  hwSerial.begin(MODEM_BAUD, SERIAL_8N1, MODEM_RX, MODEM_TX);

  // Power-Pin setzen
  pinMode(MODEM_PWR, OUTPUT);
  digitalWrite(MODEM_PWR, HIGH);
  delay(1000);

  // Modem initialisieren
  modem.restart();
  Serial.println("Modem gestartet.");

  // GNSS einschalten
  modem.sendAT("+CGNSPWR=1");
  if (modem.waitResponse(2000) == 1) {
    Serial.println("GNSS eingeschaltet.");
  } else {
    Serial.println("Fehler: GNSS konnte nicht gestartet werden!");
  }
}

void loop() {
  String res;
  modem.sendAT("+CGNSINF");
  if (modem.waitResponse(2000, res) == 1) {
    int start = res.indexOf(":");
    if (start != -1) {
      String fields = res.substring(start + 1);
      fields.trim();
      // CSV-Felder in Array
      int idx = 0;
      String tokens[20];
      for (int i = 0; i < fields.length(); i++) {
        if (fields[i] == ',') {
          idx++;
          if (idx >= 20) break;
        } else {
          tokens[idx] += fields[i];
        }
      }

      int fixStatus = tokens[1].toInt();   // 0 = kein Fix, 1 = Fix
      double lat    = tokens[3].toFloat();
      double lon    = tokens[4].toFloat();
      double alt    = tokens[5].toFloat();
      int sats      = tokens[14].toInt();  // Satelliten in use

      Serial.println("------ GPS Info ------");
      Serial.print("Fix Status : "); Serial.println(fixStatus);
      Serial.print("Latitude   : "); Serial.println(lat, 6);
      Serial.print("Longitude  : "); Serial.println(lon, 6);
      Serial.print("Altitude   : "); Serial.print(alt); Serial.println(" m");
      Serial.print("Satellites : "); Serial.println(sats);
      Serial.println("-----------------------\n");
    }
  }
  delay(5000);
}

